var socket=io.connect("http://localhost:5092"),username,blockMode="unblock",colMode="twoCol",highlightWord="";socket.on("ping",function(a){socket.emit("pong",{beat:1})});socket.on("connect",function(){$("#loginInput").on("click",loginBtHandler);$(document).on("keypress",loginBtEnterHandler)});
socket.on("connect_error",function(a){$("#sendButton").off("click",sendBtHandler);$("#container").off("click","input.likeBt");$("#container").off("click","input.shareBt");$("#container").off("click","input.revertBt");$("#container").off("click","input.translateBt");a=$("<div>").text("[SERVER] You are disconnected! Please be sure that all the record is preserved!").addClass("userMessage systemMessage");addUserMsgByColMode(a);socket.io.close()});
socket.on("loginError",function(a){$("#loginMsg").text(a);$("#username").focus()});
socket.on("userConfirm",function(a){$("#loginMsg").text(a.msg);$("#loginInput").off("click",loginBtHandler);$(document).off("keypress",loginBtEnterHandler);$("#loginBody").animate({opacity:0,hight:0},600,"swing",function(){$("#loginBody").hide();$("#controlPanel").css("visibility","visible");$("#BSTBody").css("visibility","visible").fadeIn("slow");$("#textInput").focus()});username=a.uID;0==parseInt(a.room.substring(5,7))?$("#roomInfo").text("Big Room"):$("#roomInfo").text(a.room);$("#settingBt").on("click",
settingBtHandler);$("#showLiked").on("click",bubbleLikedCtrlHandler);$("input[name=view]").on("click",blockMsgHandler);$("input[name=colMode]").on("click",windowCtrlBtHandler);$("#textInput").on("keyup keydown",inputCountHandler);$("#textInput").on("keypress",sendBtEnterHandler);$("#sendButton").on("click",sendBtHandler);$("#emitAll").prop("disabled",!0).hide();$("#unblock").attr("checked",!0);$("#twoCol").attr("checked",!0);$("#enterCheck").click();$(window).on("beforeunload",function(){return"All messages will be droped if you leave or relaod this page. \n\nAre you sure?"})});
socket.on("serverSelfMsg",function(a){a=$("<div>").text(a).addClass("userMessage systemMessage");addUserMsgByColMode(a)});socket.on("serverOthersMsg",function(a){$("#partnerMsgContainer").append($("<div>").text(a).addClass("partnerMessage systemMessage")).scrollTop($("#partnerMsgContainer").prop("scrollHeight"))});socket.on("partnerMsgLike",function(a){a=$('.postID:contains("'+a+'")').parent();var b=parseInt($(a[0]).find(".likeNum").text());$(a).each(function(){$(this).find(".likeNum").text(b+1)})});
socket.on("partnerMsgDislike",function(a){a=$('.postID:contains("'+a+'")').parent();var b=parseInt($(a[0]).find(".likeNum").text());$(a).each(function(){$(this).find(".likeNum").text(b-1)})});socket.on("memberLogin",function(a){var b=$("<span>").addClass("icon").addClass(a.uColor);a=$("<span>").addClass("memberName").text(a.uID);b=$("<div>").addClass("memberElement").append(b).append(a);$("#memberWrap").append(b)});
socket.on("memberLogout",function(a){$(".memberName").each(function(){$(this).text()==a&&$(this).parent().remove()})});
socket.on("chat",function(a){var b=a.uID,e=a.sysTime,c=$("<span>").addClass("postID").html(a.pID).hide(),d=$("<span>").addClass("msgTxt").text(a.msg),g=$("<span>").addClass("partnerIcon").addClass(a.uColor),f=$("<span>").addClass("nameSpace").text("By "+b),e=$("<span>").addClass("sysTime").text(e).hide(),e=$("<span>").addClass("timeStamp").html("@ "+localTime()).append(e),h=$("<input>").addClass("likeBt").prop({type:"button",value:""}),l=$("<span>").addClass("likeNum").text("0"),k=$("<input>").addClass("shareBt").prop({type:"button",
value:""}).hide(),m=$("<input>").addClass("translateBt").prop({type:"button",value:"Translate"}),n=$("<input>").addClass("revertBt").prop({type:"button",value:"Revert"}).hide();d.html(d.html().replace(/\n/g,"<br>"));d=$("<span>").addClass("msgCntnt").append(d).append("<br>").append(l).append(h);b==username?(d=d.append(k).append(e),d=$("<div>").addClass("userMessage").append(c).append(d),1==a.block&&k.show(),addUserMsgByColMode(d)):(d=d.append(f).append(e).append(n).append(m),d=$("<div>").addClass("partnerMessage").append(g).append(c).append(d),
1==a.block&&d.find(".msgCntnt").addClass("block"),$("#partnerMsgContainer").append(d).scrollTop($("#partnerMsgContainer").prop("scrollHeight")))});socket.on("partnerMsgBlock",function(a){$(".partnerMessage").each(function(){$(this).hasClass("share")||$(this).find(".nameSpace").text()!="By "+a.uID||(1==a.blockInfo?$(this).find(".msgCntnt").addClass("block"):$(this).find(".msgCntnt").removeClass("block"))})});
socket.on("partnerMsgShare",function(a){a=$('.postID:contains("'+a.pID+'")').parent();$(a).each(function(){$(this).addClass("share");$(this).find(".msgCntnt").removeClass("block")})});socket.on("partnerMsgUnshare",function(a){var b=$('.postID:contains("'+a.pID+'")').parent();$(b).each(function(){$(this).removeClass("share");1==a.blockInfo&&$(this).find(".msgCntnt").addClass("block")})});
socket.on("isBINDED",function(a){var b=$("<span>").addClass("trans").html(" ("+a.toWord+")"),e=$(".postID:contains('"+a.pID+"')").parent(),b=$("<span>").addClass("highlight").prop("title","By "+a.uID).html(a.fromWord).append(b);$(e).each(function(){var c=$(this).find(".msgTxt");e.hasClass("partnerMessage")?(a.uID==username&&($(this).find(".revertBt").show(),$(this).find(".translateBt").prop("disabled",!1).val("Translate").removeClass("working")),b.addClass("note")):$(this).hasClass("userMessage")&&
b.addClass("warn");c.html(powerReplace(c.html(),a.fromWord,b.prop("outerHTML")))});a.uID==username&&socket.emit("ctrlUnlock",a.pID)});socket.on("badBIND",function(a){var b=$(".postID:contains('"+a.pID+"')").parent();$(b).each(function(){$(this).find(".translateBt").prop("disabled",!1).val("Translate").removeClass("working")});b=$("<div>").text(a.msg).addClass("userMessage systemMessage");addUserMsgByColMode(b);socket.emit("ctrlUnlock",a.pID)});
socket.on("revertMsg",function(a){var b=$('.postID:contains("'+a.pID+'")').parent();$(b).each(function(){for(var b=$(this).find(".msgTxt"),c=b.find(".highlight"),d,g=b.html(),f=c.length;0<f;f--)c=$(c[f-1]),null!=c&&c.prop("title").slice(3,c.prop("title").length)==a.uID&&(d=c.clone(),c.find(".trans:last").detach(),g=g.replace(d.prop("outerHTML"),c.html())),b.html(g),c=b.find(".highlight")});a.uID==username&&(socket.emit("ctrlUnlock",a.pID),$(b).each(function(){$(this).find(".revertBt").hide()}))});
function addUserMsgByColMode(a){var b=a.clone().hide().addClass("lie");"twoCol"==colMode?($("#partnerMsgContainer").append(b),$("#userMsgContainer").append(a).scrollTop($("#userMsgContainer").prop("scrollHeight"))):"oneCol"==colMode&&($("#userMsgContainer").append(b),$("#partnerMsgContainer").append(a).scrollTop($("#partnerMsgContainer").prop("scrollHeight")))}
function powerReplace(a,b,e){var c="",d="",g=!1,f=0,h=0;if(a===b)return e;a=a.replace(/<br>/g,"%br%");b=b.replace(/<br>/g,"%br%");for(f=0;f<a.length;f++)"<"===a[f]&&(g=!0),1==g?c+="#":c+=a[f],">"===a[f]&&(g=!1);c=c.toString().indexOf(b);if(0>c)return a.toString().replace(/%br%/g,"<br>");for(f=0;f<=a.length-b.length+e.length;)f!=c?(d+=a[h],h++):(d+=e,h+=b.length,f+=e.length),f++;return d.toString().replace(/%br%/g,"<br>")}
function localTime(){var a=new Date,b=a.getHours(),b=(10>b?"0":"")+b,e=a.getMinutes(),e=(10>e?"0":"")+e,a=a.getSeconds();return b+":"+e+":"+((10>a?"0":"")+a)}function clickControl(a){a.hasClass("clicked")?a.removeClass("clicked"):a.addClass("clicked")}$("#container").on("mouseup",".partnerMessage",function(){window.getSelection?highlightWord=window.getSelection().toString():document.getSelection?highlightWord=document.getSelection().toString():document.selection&&(highlightWord=document.selection.createRange().text.toString())});
function loginBtHandler(){socket.emit("login",{usr:$("#username").val(),pwd:$("#pwd").val(),room:$("#roomName").val()});$("#username").val("");$("#pwd").val("")}function loginBtEnterHandler(a){13==a.which&&$("#loginInput").click()}function settingBtHandler(){clickControl($("#settingBt"));$("#settingWrap").toggle("blind",{direction:"right"},500)}
function blockMsgHandler(){var a=$("input[name=view]:checked").val(),b;a!=blockMode&&("block"==a?b=!0:b=!1,$("#"+a).attr("checked",!0),$("#emitAll").prop("disabled",!b),$(".shareBt").each(function(){$(this).toggle()}),$("#emitAll").toggle("blind",{direction:"right"},300),socket.emit("blockMsg",b),blockMode=a)}$("#emitAll").click(function(){$("input.shareBt").each(function(){$(this).hasClass("clicked")||$(this).click()})});
function windowCtrlBtHandler(){var a=$("input[name=colMode]:checked").val();a!=colMode&&($("#"+a).attr("checked",!0),$("#showLiked").hasClass("clicked")&&$("#showLiked").click(),"oneCol"==a?windowViewHandler("100%","0%","#userMsgContainer","#partnerMsgContainer"):"twoCol"==a&&windowViewHandler("50%","50%","#partnerMsgContainer","#userMsgContainer"),$("input[name=colMode]").prop("disabled",!0),colMode=a)}
function windowViewHandler(a,b,e,c){var d=0;$(e+" .userMessage").each(function(){$(this).hide().addClass("lie")});$("#userMsgContainer").animate({width:b},{duration:300,queue:!0});$("#partnerMsgContainer").animate({width:a},{duration:300,queue:!0,complete:function(){$(c+" .userMessage").each(function(){$(this).delay(d).show(500,function(){$(this).is(":visible")&&$(c).animate({scrollTop:$(c).prop("scrollHeight")},150)});$(this).removeClass("lie");d+=100})}});$(e).animate({scrollTop:$(e).offset().top},
100,function(){$("input[name=colMode]").prop("disabled",!1)});$(c).animate({scrollTop:$(c).offset().top},100)}
function bubbleLikedCtrlHandler(){clickControl($("#showLiked"));$("#showLiked").hasClass("clicked")?($(".msgCntnt").each(function(){var a=parseInt($(this).find(".likeNum").text()),b=$(this).parent();if(0==a||$(this).hasClass("block"))b.hasClass("lie")||b.hide("fast"),b.addClass("vote")}),$(".systemMessage").each(function(){$(this).hasClass("lie")||$(this).hide("fast");$(this).addClass("vote")}),$("#showLiked").val("Show liked bubbles: On")):($(".vote").each(function(){$(this).hasClass("lie")||$(this).show("fast");
$(this).removeClass("vote")}),$("#showLiked").val("Show liked bubbles: Off"))}function sendBtHandler(){""!==$.trim($("#textInput").val())&&(socket.emit("chatMsg",$("#textInput").val()),$("#textInput").val("").focus(),$("#textLimit").hide())}function sendBtEnterHandler(a){13!=a.which||a.shiftKey||(a.preventDefault(),$("#sendButton").click())}
function inputCountHandler(){if(500>$("#textInput").val().length)$("#textInput").off("keypress").on("keypress");else $("#textInput").on("keypress",function(){return!1}),$("#textInput").val($("#textInput").val().substring(0,500))}$("#enterCheck").click(function(){clickControl($("#checkLabel"));$("#sendButton").prop("disabled",$("#enterCheck").prop("checked"));if($(this).prop("checked"))$(document).on("keypress",sendBtEnterHandler);else $(document).off("keypress",sendBtEnterHandler)});
$("#container").on("click","input.likeBt",function(){var a=$(this).parent().siblings(".postID").text(),b=$('.postID:contains("'+a+'")').parent();$(b).each(function(){clickControl($(this).find("input.likeBt"))});$(this).hasClass("clicked")?socket.emit("likeMsg",a):socket.emit("dislikeMsg",a)});
$("#container").on("click","input.shareBt",function(){var a=$(this).parent().siblings(".postID").text(),b=$('.postID:contains("'+a+'")').parent();$(b).each(function(){var a=$(this).find("input.shareBt");clickControl(a);a.hasClass("clicked")?$(this).addClass("share"):$(this).removeClass("share")});$(this).hasClass("clicked")?socket.emit("shareMsg",a):socket.emit("unshareMsg",a)});
$("#container").on("click","input.translateBt",function(){var a=$(this).closest(".partnerMessage"),b=a.find(".postID").text();socket.emit("ctrlLock",b);a=""!=highlightWord?highlightWord:0==a.find(".highlight").length?a.find(".msgTxt").html().replace(/<br>/g,"\n"):"";""!=a&&(b={uID:username,word:a,pID:b,fromLanguage:$("#oriLang").val(),toLanguage:$("#transLang").val()},socket.emit("translate",b),$(this).prop("disabled",!0).val("WAIT...").addClass("working"))});
$("#container").on("click","input.revertBt",function(){var a=$(this).closest(".partnerMessage").find(".postID").text();socket.emit("ctrlLock",a);socket.emit("revert",{pID:a,uID:username})});$(document).ready(function(){$("#BSTBody").hide();$("#settingWrap").hide()});