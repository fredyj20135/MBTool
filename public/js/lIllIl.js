var socket=io.connect("http://localhost:5092"),username,twoCol=!0,hideEmp=!1,highlightWord="";socket.on("connect",function(){$("#loginInput").on("click",loginBtHandler);$(document).on("keypress",loginBtEnterHandler)});socket.on("loginError",function(a){$("#loginMsg").text(a)});
socket.on("userConfirm",function(a){$("#loginMsg").text(a.msg);$("#loginInput").off("click",loginBtHandler);$(document).off("keypress",loginBtEnterHandler);$("#loginBody").animate({opacity:0,hight:0},600,"swing",function(){$("#loginBody").hide();$("#controlPanel").css("visibility","visible");$("#BSTBody").css("visibility","visible").fadeIn("fast");$("#textInput").focus()});username=a.uID;$("#sendButton").on("click",sendBtHandler);$("#settingBt").on("click",settingBtHandler);$("#windowCtrlBt").on("click",
windowCtrlBtHandler);$("#textInput").on("keyup keydown",inputCountHandler);$(window).on("beforeunload",function(){return"All messages will be droped if you leave or relaod this page. \n\nAre you sure?"})});socket.on("serverSelfMsg",function(a){a=$("<div>").text(a).addClass("userMessage serverMessage");var b=a.clone().hide();twoCol?($("#partnerMsgContainer").append(b),$("#userMsgContainer").append(a).scrollTop($("#userMsgContainer").prop("scrollHeight"))):($("#userMsgContainer").append(b),$("#partnerMsgContainer").append(a).scrollTop($("#partnerMsgContainer").prop("scrollHeight")))});
socket.on("serverOthersMsg",function(a){$("#partnerMsgContainer").append($("<div>").text(a).addClass("partnerMessage serverMessage"));$("#partnerMsgContainer").scrollTop($("#partnerMsgContainer").prop("scrollHeight"))});socket.on("partnerMsgLike",function(a){a=$('.postID:contains("'+a+'")').parent();for(var b=parseInt($(a[0]).find(".likeNum").text()),c=0;c<a.length;c++)$(a[c]).find(".likeNum").text(b+1)});
socket.on("partnerMsgDislike",function(a){a=$('.postID:contains("'+a+'")').parent();for(var b=parseInt($(a[0]).find(".likeNum").text()),c=0;c<a.length;c++)$(a[c]).find(".likeNum").text(b-1)});
socket.on("chat",function(a){var b=a.uID,c=a.sysTime,d=$("<span>").addClass("msgTxt").text(a.msg),e=$("<input>").addClass("shareBt").prop({type:"button",value:""}).hide(),h=$("<input>").addClass("likeBt").prop({type:"button",value:""}),f=$("<span>").addClass("likeNum").text("0"),g=$("<input>").addClass("translateBt").prop({type:"button",value:""}),l=$("<input>").addClass("revertBt").prop({type:"button",value:"revert"}).hide(),c=$("<span>").addClass("timeStamp").html(c),k=$("<span>").addClass("postID").html(a.pID).hide(),
m=$("<span>").addClass("name").text(b),n=$("<div>").addClass("partnerIcon").addClass(a.uColor);d.html(d.html().replace(/\n/g,"<br>"));d=$("<span>").addClass("msgCntnt").append(d).append("<br>").append(h).append(f);b==username?(d=d.append(e).append(c),d=$("<div>").addClass("userMessage").append(k).append(d),1==a.block&&e.show(),a=d.clone().hide(),twoCol?($("#partnerMsgContainer").append(a),$("#userMsgContainer").append(d).scrollTop($("#userMsgContainer").prop("scrollHeight"))):($("#userMsgContainer").append(a),
$("#partnerMsgContainer").append(d).scrollTop($("#partnerMsgContainer").prop("scrollHeight")))):(d=d.append(m).append(c).append(g).append(l),d=$("<div>").addClass("partnerMessage").append(n).append(k).append(d),1==a.block&&d.find(".msgCntnt").addClass("block"),1==hideEmp&&d.hide(),$("#partnerMsgContainer").append(d).scrollTop($("#partnerMsgContainer").prop("scrollHeight")))});
socket.on("partnerMsgBlock",function(a){$(".partnerMessage").each(function(){$(this).hasClass("share")||$(this).find(".name").text()!=a.uID||(1==a.blockInfo?$(this).find(".msgCntnt").addClass("block"):$(this).find(".msgCntnt").removeClass("block"))});bubbleCtrl()});socket.on("partnerMsgShare",function(a){a=$('.postID:contains("'+a.pID+'")').parent();for(var b=0;b<a.length;b++)$(a[b]).addClass("share"),$(a[b]).find(".msgCntnt").removeClass("block");bubbleCtrl()});
socket.on("partnerMsgUnshare",function(a){for(var b=$('.postID:contains("'+a.pID+'")').parent(),c=0;c<b.length;c++)$(b[c]).removeClass("share"),1==a.blockInfo&&$(b[c]).find(".msgCntnt").addClass("block");bubbleCtrl()});
socket.on("is BINDED",function(a){for(var b=$("<span>").addClass("trans").html(" ("+a.toWord+")"),c=$(".postID:contains('"+a.pID+"')").parent(),b=$("<span>").addClass("highlight").prop("title","By "+a.uID).html(a.fromWord).append(b),d=0;d<c.length;d++){var e=$(c[d]).find(".msgTxt");c.hasClass("partnerMessage")?(c.find(".revertBt").show(),b.addClass("note")):c.hasClass("userMessage")&&b.addClass("warn");e.html(powerReplace(e.html(),a.fromWord,b.prop("outerHTML")))}a.uID==username&&socket.emit("ctrlUnlock",
a.pID)});function powerReplace(a,b,c){var d="",e="",h=!1,f=0,g=0;if(a===b)return c;a=a.replace(/<br>/g,"%br%");b=b.replace(/<br>/g,"%br%");for(f=0;f<a.length;f++)"<"===a[f]&&(h=!0),1==h?d+="#":d+=a[f],">"===a[f]&&(h=!1);d=d.toString().indexOf(b);if(0>d)return a;for(f=0;f<=a.length-b.length+c.length;)f!=d?(e+=a[g],g++):(e+=c,g+=b.length,f+=c.length),f++;return e.toString().replace(/%br%/g,"<br>")}
socket.on("revertMsg",function(a){for(var b=$('.postID:contains("'+a.pID+'")').parent(),c=0;c<b.length;c++){for(var d=$(b[c]).find(".msgTxt"),e=d.find(".highlight"),h,f=d.html(),g=e.length;0<g;g--)e=$(e[g-1]),null!=e&&e.prop("title").slice(3,e.prop("title").length)==a.user&&(h=e.clone(),e.find(".trans:last").detach(),f=f.replace(h.prop("outerHTML"),e.html())),d.html(f),e=d.find(".highlight");0!=$(b[c]).find(".revertBt").length&&$(b[c]).find(".revertBt").hide()}a.uID==username&&socket.emit("ctrlUnlock",
a.pID)});function bubbleCtrl(){$("#hideUnshare").hasClass("clicked")?$(".partnerMessage").each(function(){$(this).find(".msgCntnt").hasClass("block")?$(this).hide("slow"):$(this).show("slow")}):$(".partnerMessage").each(function(){$(this).show("slow")})}function loginBtHandler(){socket.emit("login",{usr:$("#username").val(),pwd:$("#pwd").val()});$("#username").val("");$("#pwd").val("")}function loginBtEnterHandler(a){13==a.which&&$("#loginInput").click()}
function windowCtrlBtHandler(){var a,b,c,d;1==twoCol?twoCol=!1:twoCol=!0;$("#windowCtrlBt").hasClass("clicked")?($("#windowCtrlBt").text("To two columns"),d="100%",c="0%",b=$("#userMsgContainer .userMessage"),a=$("#partnerMsgContainer .userMessage")):($("#windowCtrlBt").text("To one column"),c=d="50%",a=$("#userMsgContainer .userMessage"),b=$("#partnerMsgContainer .userMessage"));b.each(function(){$(this).hide("slow")});windowAnimate(c,d);a.each(function(){$(this).show("fast")});$("#userMsgContainer").scrollTop($("#userMsgContainer").prop("scrollHeight"));
$("#partnerMsgContainer").scrollTop($("#partnerMsgContainer").prop("scrollHeight"))}function windowAnimate(a,b){$("#windowCtrlBt").prop("disabled",!0);$("#userMsgContainer").animate({width:a},{duration:600,queue:!0});$("#partnerMsgContainer").animate({width:b},{duration:600,queue:!1,complete:function(){$("#windowCtrlBt").prop("disabled",!1)}})}
function inputCountHandler(){500>$("#textInput").val().length?($("#textLimit").text(""),$("#textInput").off("keypress").on("keypress")):($("#textInput").on("keypress",function(){return!1}),$("#textLimit").text("You have exceeded the maximum input"),$("#textInput").val($("#textInput").val().substring(0,500)))}function sendBtHandler(){socket.emit("chat message",$("#textInput").val());$("#textInput").val("").focus();$("#textLimit").text("")}
function settingBtHandler(){$("#settingPanel").is(":visible")?($("#settingPanel").hide(),$("#sendButton").show("slow"),$("#textInput").show("slow")):($("#settingPanel").show("slow"),$("#sendButton").hide("slow"),$("#textInput").hide())}function clickControl(a){a.hasClass("clicked")?a.removeClass("clicked"):a.addClass("clicked")}
$("#blockAll").click(function(){clickControl($(this));$(this).hasClass("clicked")?($("#emitAll").prop("disabled",!1),socket.emit("blockMsg",!0),$(".shareBt").each(function(){$(this).show()}),$(this).val("Unblock all my messages")):($("#emitAll").prop("disabled",!0),socket.emit("blockMsg",!1),$(".shareBt").each(function(){$(this).hide()}),$(this).val("Block all my messages"))});$("#emitAll").click(function(){$("input.shareBt").each(function(){$(this).hasClass("clicked")||$(this).click()})});
$("#hideUnshare").click(function(){clickControl($(this));$(this).hasClass("clicked")?$(this).val("Show all bubbles"):$(this).val("Hide empty bubbles");1==hideEmp?hideEmp=!1:hideEmp=!0;bubbleCtrl()});$("#settingBt").click(function(){clickControl($(this))});$("#windowCtrlBt").click(function(){clickControl($(this))});
$("#container").on("click","input.likeBt",function(){for(var a=$(this).parent().prev().text(),b=$('.postID:contains("'+a+'")').parent(),c=0;c<b.length;c++){var d=$(b[c]).find("input.likeBt");clickControl(d)}d.hasClass("clicked")?socket.emit("likeMsg",a):socket.emit("dislikeMsg",a)});
$("#container").on("click","input.shareBt",function(){for(var a=$(this).parent().prev().text(),b=$('.postID:contains("'+a+'")').parent(),c=0;c<b.length;c++){var d=$(b[c]).find("input.shareBt");clickControl(d);d.hasClass("clicked")?$(b[c]).addClass("share"):$(b[c]).removeClass("share")}d.hasClass("clicked")?socket.emit("shareMsg",a):socket.emit("unshareMsg",a)});
$("#container").on("mouseup",".partnerMessage",function(){window.getSelection?highlightWord=window.getSelection().toString():document.getSelection?highlightWord=document.getSelection().toString():document.selection&&(highlightWord=document.selection.createRange().text.toString())});
$("#container").on("click","input.translateBt",function(){var a=$(this).closest(".partnerMessage"),b=a.find(".postID").text();socket.emit("ctrlLock",b);a=""!=highlightWord?highlightWord:0==a.find(".highlight").length?a.find(".msgTxt").html().replace(/<br>/g,"\n"):"";""!=a&&(b={uID:username,word:a,pID:b,fromLanguage:$("#oriLang").val(),toLanguage:$("#transLang").val()},socket.emit("translate",b))});
$("#container").on("click","input.revertBt",function(){var a=$(this).closest(".partnerMessage").find(".postID").text();socket.emit("ctrlLock",a);socket.emit("revert",{pID:a,user:username})});$(document).ready(function(){$("#BSTBody").hide();$("#settingPanel").hide();$("#emitAll").prop("disabled",!0)});